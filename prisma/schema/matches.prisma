model Match {
    id Int @id @default(autoincrement())
    name String? @unique
    private Boolean
    joinCode String? @unique
    players UsersInMatch[]
    createdAt DateTime @default(now())
    logEntries MatchLog[]
    currentRound Int @default(0)
    gameCompleted Boolean @default(false)
    teams MatchTeam[]
}

model UsersInMatch {
    id Int @id @default(autoincrement())
    match Match @relation(references: [id], fields: [matchId], onDelete: Cascade)
    matchId Int
    player User @relation(references: [id], fields: [playerId], onDelete: Cascade)
    playerId String
    playerNickname String
    playerFaction String?
    playerRole PlayerRole
    lists MatchList[]
    team MatchTeam? @relation(references: [id], fields: [teamId], onDelete: Cascade)
    teamId Int?
    logs MatchLog[]
    
    @@unique([matchId, playerId], name: "match_player")
}

model MatchTeam {
    id Int @id @default(autoincrement())
    name String
    objectivePoints Int @default(0)
    match Match @relation(references: [id], fields: [matchId], onDelete: Cascade)
    matchId Int
    lists MatchList[]
    teammates UsersInMatch[]
}

model MatchList {
    id Int @id @default(autoincrement())
    player UsersInMatch @relation(references: [matchId, playerId], fields: [matchId, playerId], onDelete: Cascade)
    matchId Int
    playerId String
    name String
    team MatchTeam @relation(references: [id], fields: [teamId], onDelete: Cascade)
    teamId Int
    formations MatchFormation[]
}

model MatchFormation {
    id Int @id @default(autoincrement())
    name String
    type String
    secondaryType String?
    list MatchList @relation(references: [id], fields: [listId], onDelete: Cascade)
    listId Int
    units MatchUnit[]
}

model MatchUnit {
    id Int @id @default(autoincrement())
    mulId Int
    skill Int
    secondary Boolean
    pendingDamage Int @default(0)
    pendingHeat Int @default(0)
    currentDamage Int @default(0)
    currentHeat Int @default(0)
    criticals MatchCrit[]
    formation MatchFormation @relation(references: [id], fields: [formationId], onDelete: Cascade)
    formationId Int
    spas String?
    ammo String?
}
 
model MatchCrit {
    id Int @id @default(autoincrement())
    unit MatchUnit @relation(references: [id], fields: [unitId], onDelete: Cascade)
    unitId Int
    round Int
    pending Boolean
    type String
    roundsRemaining Int?
}

model MatchLog {
    id Int @id @default(autoincrement())
    match Match @relation(references: [id], fields: [matchId], onDelete: Cascade)
    matchId Int
    submitter UsersInMatch @relation(references: [id], fields: [submitterId], onDelete: Cascade)
    submitterId Int
    updated_at DateTime @default(now())
    round Int
    type LogType
    unitId Int?
    applied Boolean?
    details Json?
}

enum PlayerRole {
    HOST
    MODERATOR
    PLAYER
}
 
enum LogType {
    MATCH_CREATED
    MATCH_START
    MATCH_UPDATE
    MATCH_END
    MATCH_DELETE
    PLAYER_JOINED
    PLAYER_ADDED_LIST
    PLAYER_LEFT
    REMOVE_PLAYER
    ROUND_END
    UNIT_DAMAGE
    UNIT_DAMAGE_REMOVED
    UNIT_HEAT
    UNIT_CRIT
    UNIT_CRIT_REMOVED
}